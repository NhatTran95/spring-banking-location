<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>List of customers</title>
    <th:block th:replace="layout/head :: head"/>
    <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/web-toast/src/webToast.css">
    <link rel="stylesheet" href="/assets/css/custom-style.css">
</head>
<body>
<div class="container-fluid">
    <header>
        <nav class="navbar bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand">List of customers</a>
                <div class="d-flex" style="gap: 10px;">
                    <a href="/customers/histories">
                        <button class="btn btn-outline-light" type="button">
                            <i class="fas fa-history"></i>
                            Transfer histories
                        </button>
                    </a>
                    <button class="btn btn-outline-light" type="button" id="btnShowModalCreate">
                        <i class="far fa-plus-square"></i>
                        Add new customer
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <div class="content">
        <table class="table table-hover">
            <thead>
            <tr>
                <th>#</th>
                <th>FullName</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Balance</th>
                <th>Province</th>
                <th>District</th>
                <th>Ward</th>
                <th>Address</th>
                <th colspan="5" class="text-center">Action</th>
            </tr>
            </thead>
            <tbody id="tbCustomerBody">
            <!-- Dữ liệu khách hàng sẽ được thêm vào đây bằng JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Create Form -->
<th:block th:replace="customer/create"/>

<!-- Edit Form -->
<th:block th:replace="customer/edit"/>

<!-- Deposit Form -->
<th:block th:replace="customer/deposit"/>

<!-- Withdraw Form -->
<th:block th:replace="customer/withdraw"/>

<!-- Transfer Form -->
<th:block th:replace="customer/transfer"/>


<script src="/assets/jquery/jquery-3.5.1.min.js"></script>
<script src="/assets/jquery/jquery.validate.min.js"></script>
<script src="/assets/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="/assets/web-toast/src/webToast.js"></script>
<script src="/assets/js/app-base.js"></script>

<script>

    const page = {
        urls: {
            getAllCustomers: AppBase.API_CUSTOMER,
            getCustomerById: AppBase.API_CUSTOMER,
            createCustomer: AppBase.API_CUSTOMER,
            updateCustomer: AppBase.API_CUSTOMER,
            deposit: AppBase.API_CUSTOMER + '/deposit',
            withdraw: AppBase.API_CUSTOMER + '/withdraw',
            transfer: AppBase.API_CUSTOMER + '/transfer',
            delete: AppBase.API_CUSTOMER
        },
        elements: {},
        loadData: {},
        commands: {}
    }
    // Create
    page.elements.btnShowModalCreate = $('#btnShowModalCreate');
    page.elements.frmCreate = $('#formCreate');
    page.elements.modalCreate = $('#modalCreate');
    page.elements.fullNameCre = $('#fullNameCre');
    page.elements.emailCre = $('#emailCre');
    page.elements.phoneCre = $('#phoneCre');
    page.elements.balanceCre = $('#balanceCre');
    page.elements.provinceCre = $('#provinceCre');
    page.elements.districtCre = $('#districtCre');
    page.elements.wardCre = $('#wardCre');
    page.elements.addressCre = $('#addressCre');
    page.elements.btnCreate = $('#btnCreate');

    // Update
    page.elements.modalUpdate = $('#modalUpdate');
    page.elements.frmUpdate = $('#formUpdate');
    page.elements.provinceUp = $('#provinceUp');
    page.elements.districtUp = $('#districtUp');
    page.elements.wardUp = $('#wardUp');
    page.elements.addressUp = $('#addressUp');
    page.elements.fullNameUp = $('#fullNameUp');
    page.elements.idUp = $('#idUp');
    page.elements.emailUp = $('#emailUp');
    page.elements.phoneUp = $('#phoneUp');
    page.elements.btnUpdate = $('#btnUpdate');

    // Deposit
    page.elements.btnDeposit = $('#btnDeposit');
    page.elements.modalDeposit = $('#modalDeposit');
    page.elements.formDeposit = $('#formDes');
    page.elements.idDeposit = $('#idDes');
    page.elements.fullNameDeposit = $('#fullNameDes');
    page.elements.emailDeposit = $('#emailDes');
    page.elements.balanceDeposit = $('#balanceDes');
    page.elements.transactionAmountDeposit = $('#amountDes');

    // Withdraw
    page.elements.btnWithdraw = $('#btnWithdraw');
    page.elements.modalWithdraw = $('#modalWithdraw');
    page.elements.formWithdraw = $('#formWdr');
    page.elements.idWithdraw = $('#idWdr');
    page.elements.fullNameWithdraw = $('#fullNameWdr');
    page.elements.emailWithdraw = $('#emailWdr');
    page.elements.balanceWithdraw = $('#balanceWdr');
    page.elements.transactionAmountWithdraw = $('#amountWdr');

    // Transfer
    page.elements.btnTransfer = $('#btnTransfer');
    page.elements.modalTransfer = $('#modalTransfer');
    page.elements.formTransfer = $('#formTr');
    page.elements.senderName = $('#senderName');
    page.elements.idSer = $('#idSer');
    page.elements.emailSer = $('#emailSer');
    page.elements.balanceSer = $('#balanceSer');
    page.elements.fee = $('#fee');
    page.elements.transferAmount = $('#amountTr');
    page.elements.totalAmount = $('#totalAmount');
    page.elements.selectRecipient = $('#recipient');


    page.elements.strBody = $('#tbCustomerBody');
    let customers = [];
    let customer = new Customer();
    let locationRegion = new LocationRegion();

    page.commands.getAllProvinces = () => {
        return $.ajax({
            url: 'https://vapi.vnappmob.com/api/province/'
        })
            .done((data) => {
                const provinces = data.results;

                $.each(provinces, (index, item) => {
                    const str = renderOptionProvince(item);
                    page.elements.provinceCre.append(str);
                    page.elements.provinceUp.append(str);
                })
            })
            .fail((error) => {
                console.log(error);
            })
    }

    page.commands.getAllDistrictsByProvinceId = (provinceId, element) => {
        return $.ajax({
            url: 'https://vapi.vnappmob.com/api/province/district/' + provinceId
        })
            .done((data) => {
                const districts = data.results;

                element.empty();


                $.each(districts, (index, item) => {
                    const str = renderOptionDistrict(item);
                    element.append(str);

                })
            })
            .fail((error) => {
                console.log(error);
            })
    }

    page.commands.getAllWardsByDistrictId = (districtId, element) => {
        return $.ajax({
            url: 'https://vapi.vnappmob.com/api/province/ward/' + districtId
        })
            .done((data) => {
                const wards = data.results;

                element.empty();

                $.each(wards, (index, item) => {
                    const str = renderOptionWard(item);
                    element.append(str);
                })
            })
            .fail((error) => {
                console.log(error);
            })
    }

    const renderOptionProvince = (obj) => {
        return `<option value="${obj.province_id}">${obj.province_name}</option>`
    }

    const renderOptionDistrict = (obj) => {
        return `<option value="${obj.district_id}">${obj.district_name}</option>`;
    }

    const renderOptionWard = (obj) => {
        return `<option value="${obj.ward_id}">${obj.ward_name}</option>`;
    }

    const renderCustomer = (obj) => {
        return `
            <tr id="tr_${obj.id}">
                <td>${obj.id}</td>
                <td>${obj.fullName}</td>
                <td>${obj.email}</td>
                <td>${obj.phone}</td>
                <td>${obj.balance}</td>
                <td>${obj.locationRegion.provinceName}</td>
                <td>${obj.locationRegion.districtName}</td>
                <td>${obj.locationRegion.wardName}</td>
                <td>${obj.locationRegion.address}</td>
                <td>
                    <button title = "Edit" class="btn btn-outline-secondary edit" data-id="${obj.id}">
                        <i class="fas fa-user-edit"></i>
                    </button>
                </td>
                <td>
                    <button title = "Deposit" class="btn btn-outline-success deposit" data-id="${obj.id}">
                        <i class="fas fa-plus"></i>
                    </button>
                </td>
                <td>
                    <button title = "Withdraw" class="btn btn-outline-warning withdraw" data-id = "${obj.id}">
                        <i class="fas fa-minus"></i>
                    </button>
                </td>
                <td>
                    <button title = "Transfer" class="btn btn-outline-primary transfer" data-id = "${obj.id}">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                </td>
                <td>
                    <button title = "Delete" class="btn btn-outline-danger delete" data-id="${obj.id}">
                        <i class="fas fa-user-slash"></i>
                    </button>
                </td>
            </tr>
            `;
    }

    page.elements.provinceCre.on('change', function () {
        const provinceId = $(this).val();
        page.commands.getAllDistrictsByProvinceId(provinceId, page.elements.districtCre).then((data) => {
            const districtId = page.elements.districtCre.val();

            page.commands.getAllWardsByDistrictId(districtId, page.elements.wardCre);
        });
    })

    page.elements.provinceUp.on('change', function () {
        const provinceId = $(this).val();
        page.commands.getAllDistrictsByProvinceId(provinceId, page.elements.districtUp).then((data) => {
            const districtId = page.elements.districtUp.val();

            page.commands.getAllWardsByDistrictId(districtId, page.elements.wardUp);
        });
    })

    page.elements.districtCre.on('change', function () {
        const districtId = $(this).val();
        page.commands.getAllWardsByDistrictId(districtId, page.elements.wardCre);
    })

    page.elements.districtUp.on('change', function () {
        const districtId = $(this).val();
        page.commands.getAllWardsByDistrictId(districtId, page.elements.wardUp);
    })
    const renderNameCus = (obj) => {
        return `
                <option value="${obj.id}">${obj.fullName}</option>
            `
    }

    page.commands.getAllCustomers = () => {
        return $.ajax({
            type: 'GET',
            url: page.urls.getAllCustomers,
            success: function (response) {
                customers = response;
                page.elements.strBody.empty();

                $.each(response, (index, item) => {
                    const str = renderCustomer(item);
                    page.elements.strBody.prepend(str);
                })
            }, error: function () {
                alert('Error');
            }
        })
    }

    page.commands.createCustomer = () => {
        page.elements.btnCreate.attr('disable', true);

        let load = webToast.loading({
            status: 'Loading...',
            message: 'Please wait a moment',
            align: 'bottomright',
            line: true,
        });

        locationRegion.id = null;
        locationRegion.provinceId = page.elements.provinceCre.val();
        locationRegion.provinceName = page.elements.provinceCre.find('option:selected').text();
        locationRegion.districtId = page.elements.districtCre.val();
        locationRegion.districtName = page.elements.districtCre.find('option:selected').text();
        locationRegion.wardId = page.elements.wardCre.val();
        locationRegion.wardName = page.elements.wardCre.find('option:selected').text();
        locationRegion.address = page.elements.addressCre.val();

        customer.id = null;
        customer.fullName = page.elements.fullNameCre.val();
        customer.email = page.elements.emailCre.val();
        customer.phone = page.elements.phoneCre.val();
        customer.locationRegion = locationRegion;
        customer.balance = 0;
        customer.deleted = 0;

        setTimeout(() => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json',
                },
                type: 'POST',
                url: page.urls.createCustomer,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = renderCustomer(data);
                    page.elements.strBody.prepend(str);
                    page.elements.modalCreate.modal('hide');

                    webToast.Success({
                        status: 'Thêm mới thành công',
                        message: '',
                        delay: 2000,
                        align: 'topright'
                    });
                })
                .fail((error) => {
                    console.log(error);
                })
                .always(() => {
                    page.elements.btnCreate.attr('disable', false);
                    load.remove();
                })
        }, 1000);
    }

    page.commands.showUpdate = () => {
        page.elements.strBody.on('click', '.edit', function () {
            resetForm('#formUpdate');
            const id = $(this).data('id');

            $.ajax({
                url: page.urls.updateCustomer + '/' + id
            })
                .done((data) => {
                    if (Object.keys(data).length > 0) {

                        const provinceId = data.locationRegion.provinceId;
                        const districtId = data.locationRegion.districtId;
                        const wardId = data.locationRegion.wardId;

                        page.commands.getAllDistrictsByProvinceId(provinceId, page.elements.districtUp).then((data) => {
                            page.elements.districtUp.val(districtId);

                            page.commands.getAllWardsByDistrictId(districtId, page.elements.wardUp).then((data) => {
                                page.elements.wardUp.val(wardId);
                            })
                        })

                        page.elements.idUp.val(data.id);
                        page.elements.fullNameUp.val(data.fullName);
                        page.elements.emailUp.val(data.email);
                        page.elements.phoneUp.val(data.phone);
                        page.elements.provinceUp.val(provinceId);
                        page.elements.addressUp.val(data.locationRegion.address);

                        page.elements.modalUpdate.modal('show');
                    } else {
                        alert('Cant find any Customer with that ID');
                    }
                })
                .fail((error) => {
                    console.log(error);
                })
        })
    }

    page.commands.updateCustomer = () => {
        page.elements.btnUpdate.attr('disabled', true);

        const customerId = page.elements.idUp.val();

        let load = webToast.loading({
            status: 'Loading...',
            message: 'Please wait a moment...',
            align: 'bottomright',
            line: true,
        });


        locationRegion.provinceId = page.elements.provinceUp.val();
        locationRegion.provinceName = page.elements.provinceUp.find('option:selected').text();
        locationRegion.districtId = page.elements.districtUp.val();
        locationRegion.districtName = page.elements.districtUp.find('option:selected').text();
        locationRegion.wardId = page.elements.wardUp.val();
        locationRegion.wardName = page.elements.wardUp.find('option:selected').text();
        locationRegion.address = page.elements.addressUp.val();

        customer.id = customerId
        customer.fullName = page.elements.fullNameUp.val();
        customer.email = page.elements.emailUp.val();
        customer.phone = page.elements.phoneUp.val();
        customer.locationRegion = locationRegion;
        customer.balance = 0;
        customer.deleted = 0;
        console.log(customer);

        setTimeout(() => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.urls.updateCustomer + '/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = renderCustomer(data);
                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    page.elements.modalUpdate.modal('hide');

                    webToast.Success({
                        status: 'Cập nhật thành công!',
                        message: '',
                        delay: 2000,
                        align: 'topright'
                    });
                })
                .fail((errors) => {
                    const responseJSON = errors.responseJSON;

                    if(responseJSON) {
                        let str = '<ul>';
                        $.each(responseJSON, (k, v) => {
                            str += `<li><label>${v}</label></li>`
                        })
                        str += '</ul>'

                        $('.error-area').empty().append(str).removeClass('hide').addClass('show');
                    }
                })
                .always(() => {
                    page.elements.btnUpdate.attr('disabled', false);
                    load.remove();
                })
        }, 1000);
    };

    page.commands.deleteCustomer = () => {
        page.elements.strBody.on('click', '.delete', function () {
            const id = $(this).data('id');
            const fullName = $(`#tr_${id} td:nth-child(2)`).text();

            const confirmBox = webToast.confirm("Are you sure you want to delete customer " + fullName + "?");
            confirmBox.click(function () {
                confirmBox.attr('disabled', true);

                let load = webToast.loading({
                    status: 'Loading...',
                    message: 'Please Wait a moment',
                    align: 'bottomright',
                    line: true,
                });

                customer.id = id;

                setTimeout(() => {
                    $.ajax({
                        headers: {
                            'accept': 'application/json',
                            'content-type': 'application/json'
                        },
                        type: 'DELETE',
                        url: page.urls.delete + '/' + id,
                        data: JSON.stringify(customer)
                    })
                        .done(() => {
                            const currentRow = $('#tr_' + id);
                            currentRow.remove();
                            webToast.Success({
                                status: 'Xóa thành công',
                                message: '',
                                delay: 2000,
                                align: 'topright'
                            });

                        })
                        .fail((error) => {
                            console.log(error);
                        })
                        .always(() => {
                            // getAllCustomers();
                            confirmBox.attr('disabled', false);
                            load.remove();
                        })
                }, 1000);
            });
        });
    }

    page.commands.getCustomerById = (id) => {
        return $.ajax({
            url: page.urls.getCustomerById + '/' + id
        })
    }

    page.commands.showDeposit = () => {
        page.elements.strBody.on('click', '.deposit', function () {
            resetForm('#formDes');
            const id = $(this).data('id');
            page.commands.getCustomerById(id).then((data) => {
                customer = data;

                page.elements.formDeposit.trigger('reset');
                page.elements.idDeposit.val(customer.id);
                page.elements.fullNameDeposit.val(customer.fullName);
                page.elements.emailDeposit.val(customer.email);
                page.elements.balanceDeposit.val(customer.balance);

                page.elements.modalDeposit.modal('show');
            }).catch((error) => {
                console.log(error);

                webToast.Danger({
                    status: 'Không tồn tại dữ liệu khách hàng',
                    message: '',
                    delay: 2000,
                    align: 'topright'
                });
            })
        });
    }

    page.commands.deposit = () => {
        page.elements.btnDeposit.attr('disabled', true);

        let load = webToast.loading({
            status: 'Loading...',
            message: 'Please Wait a moment',
            align: 'bottomright',
            line: true,
        });

        const obj = {
            customerId: page.elements.idDeposit.val(),
            transactionAmount: page.elements.transactionAmountDeposit.val()
        }

        setTimeout(() => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.urls.deposit,
                data: JSON.stringify(obj)
            })
                .done((data) => {
                    page.elements.modalDeposit.modal('hide');

                    const str = renderCustomer(data);
                    $('#tr_' + obj.customerId).replaceWith(str);

                    webToast.Success({
                        status: 'Nạp tiền vào tài khoản thành công!',
                        message: '',
                        delay: 2000,
                        align: 'topright'
                    });
                })
                .fail((errors) => {
                    const responseJSON = errors.responseJSON;

                    if(responseJSON) {
                        let str = '<ul>';
                        $.each(responseJSON, (k, v) => {
                            str += `<li><label>${v}</label></li>`
                        })
                        str += '</ul>'

                        $('.error-area').empty().append(str).removeClass('hide').addClass('show');
                    }
                })
                .always(() => {
                    page.elements.btnDeposit.attr('disabled', false);
                    load.remove();
                })
        },1000)

    }

    page.commands.showWithdraw = () => {
        page.elements.strBody.on('click', '.withdraw', function () {
            resetForm('#formWdr');
            const id = $(this).data('id');
            page.commands.getCustomerById(id).then((data) => {
                customer = data;

                page.elements.formWithdraw.trigger('reset');
                page.elements.idWithdraw.val(customer.id);
                page.elements.fullNameWithdraw.val(customer.fullName);
                page.elements.emailWithdraw.val(customer.email);
                page.elements.balanceWithdraw.val(customer.balance);

                page.elements.modalWithdraw.modal('show');
            }).catch((error) => {
                console.log(error);

                webToast.Danger({
                    status: 'Không tồn tại dữ liệu khách hàng',
                    message: '',
                    delay: 2000,
                    align: 'topright'
                });
            })
        });
    }

    page.commands.withdraw = () => {

        page.elements.btnWithdraw.attr('disabled', true);

        let load = webToast.loading({
            status: 'Loading...',
            message: 'Please Wait a moment',
            align: 'bottomright',
            line: true,
        });

        const obj = {
            customerId: page.elements.idWithdraw.val(),
            transactionAmount: page.elements.transactionAmountWithdraw.val()
        }

        setTimeout(() => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.urls.withdraw,
                data: JSON.stringify(obj)
            })
                .done((data) => {
                    page.elements.modalWithdraw.modal('hide');

                    const str = renderCustomer(data);
                    $('#tr_' + obj.customerId).replaceWith(str);

                    webToast.Success({
                        status: 'Rút tiền từ tài khoản thành công!',
                        message: '',
                        delay: 2000,
                        align: 'topright'
                    });
                })
                .fail((errors) => {
                    const responseJSON = errors.responseJSON;

                    if(responseJSON) {
                        let str = '<ul>';
                        $.each(responseJSON, (k, v) => {
                            str += `<li><label>${v}</label></li>`
                        })
                        str += '</ul>'

                        $('.error-area').empty().append(str).removeClass('hide').addClass('show');
                    }
                })
                .always(() => {
                    page.elements.btnWithdraw.attr('disabled', false);
                    load.remove();
                })
        },1000)

    }

    page.commands.showTransfer = () => {
        page.elements.strBody.on('click', '.transfer', function () {
            resetForm('#formTr');
            const id = $(this).data('id');

            page.commands.getCustomerById(id)
                .done((data) => {
                    if (Object.keys(data).length) {
                        page.elements.senderName.val(data.fullName);
                        page.elements.idSer.val(data.id);
                        page.elements.emailSer.val(data.email);
                        page.elements.balanceSer.val(data.balance);
                        page.elements.fee.val(10);

                        // const strSelect = $('#recipient');
                        page.elements.transferAmount.on('input', () => {
                            let fee = parseFloat($('#fee').val());
                            let totalAmount = Math.round(parseFloat(page.elements.transferAmount.val()) * (1 + fee / 100));
                            page.elements.totalAmount.val(totalAmount);
                        })

                        page.commands.getAllCustomers();

                        let filteredCustomers = customers.filter(function (item) {
                            return item.id !== id;
                        });

                        page.elements.selectRecipient.empty();

                        $.each(filteredCustomers, function (index, item) {
                            let str = renderNameCus(item);
                            page.elements.selectRecipient.append(str);
                        });
                        page.elements.modalTransfer.modal('show');
                    } else {
                        alert('Cant do anything!');
                    }
                })

        });
    }

    page.commands.transfer = () => {
        const senderId = page.elements.idSer.val();
        const recipientId = page.elements.selectRecipient.val();
        const transferAmount = page.elements.transferAmount.val();

        page.elements.btnTransfer.attr('disabled', true);

        let load = webToast.loading({
            status: 'Loading...',
            message: 'Please Wait a moment',
            align: 'bottomright',
            line: true,
        });

        const transfer = {
            senderId: senderId,
            recipientId: recipientId,
            transferAmount: transferAmount
        }

        setTimeout(() => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.urls.transfer,
                data: JSON.stringify(transfer)
            })
                .done((data) => {
                    const strSender = renderCustomer(data.sender);
                    const currentRow = $('#tr_' + senderId);
                    currentRow.replaceWith(strSender);

                    const strRecipient = renderCustomer(data.recipient);
                    const currentRowR = $('#tr_' + recipientId);
                    currentRowR.replaceWith(strRecipient);

                    page.elements.modalTransfer.modal('hide');

                    webToast.Success({
                        status: 'Chuyển tiền thành công!',
                        message: '',
                        delay: 2000,
                        align: 'topright'
                    });
                })
                .fail((errors) => {
                    const responseJSON = errors.responseJSON;

                    if(responseJSON) {
                        let str = '<ul>';
                        $.each(responseJSON, (k, v) => {
                            str += `<li><label>${v}</label></li>`
                        })
                        str += '</ul>'

                        $('.error-area').empty().append(str).removeClass('hide').addClass('show');
                    }

                })
                .always(() => {
                    page.elements.btnTransfer.attr('disabled', false);
                    load.remove();
                })
        }, 1000);
    }

    page.elements.frmCreate.validate({
        rules: {
            fullNameCre: {
                required: true,
                minlength: 5,
                maxlength: 25
            },
            emailCre: {
                required: true,
                isEmail: true
            },
            phoneCre: {
                required: true,

            }
        },
        messages: {
            fullNameCre: {
                required: 'Vui lòng nhập họ tên đầy đủ',
                minlength: 'Họ tên tối thiểu là 5 ký tự',
                maxlength: 'Họ tên tối đa là 25 ký tự'
            },
            emailCre: {
                required: 'Vui lòng nhập email đầy đủ',
            },
            phoneCre: {
                required: 'Vui lòng nhập phone đầy đủ'

            }
        },
        submitHandler: function () {
            page.commands.createCustomer();
        }
    })
    page.elements.frmUpdate.validate({
        rules: {
            fullNameUp: {
                required: true,
                minlength: 5,
                maxlength: 25
            },
            emailUp: {
                required: true,
                isEmail: true
            },
            phoneUp: {
                required: true,

            },
            addressUp: {
                required: true
            }
        },
        messages: {
            fullNameUp: {
                required: 'Vui lòng nhập họ tên đầy đủ',
                minlength: 'Họ tên tối thiểu là 5 ký tự',
                maxlength: 'Họ tên tối đa là 25 ký tự'
            },
            emailUp: {
                required: 'Vui lòng nhập email đầy đủ',
            },
            phoneUp: {
                required: 'Vui lòng nhập phone đầy đủ'
            },
            addressUp: {
                required: 'Vui lòng nhập địa chỉ đầy đủ'
            }
        },
        errorLabelContainer: "#modalUpdate .error-area",
        errorPlacement: function (error, element) {
            error.appendTo("#modalUpdate .error-area");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $('.error-area').removeClass('show').addClass('hide').empty();
                $("#modalUpdate .error-area").removeClass("hide").addClass("show");
            } else {
                $("#modalUpdate .error-area").removeClass("show").addClass("hide").empty();
                $("#formUpdate input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.commands.updateCustomer();
        }
    })
    page.elements.formDeposit.validate({
        rules: {
            amountDes: {
                required: true,
                isNumber: true
            }
        },
        messages: {
            amountDes: {
                required: 'Vui lòng nhập tiền giao dịch'
            }
        },
        errorLabelContainer: "#modalDeposit .error-area",
        errorPlacement: function (error, element) {
            error.appendTo("#modalDeposit .error-area");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $('.error-area').removeClass('show').addClass('hide').empty();
                $("#modalDeposit .error-area").removeClass("hide").addClass("show");
            } else {
                $("#modalDeposit .error-area").removeClass("show").addClass("hide").empty();
                $("#formDes input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.commands.deposit();
        }
    })

    page.elements.formWithdraw.validate({
        rules: {
            amountWdr: {
                required: true,
                isNumber: true
            }
        },
        messages: {
            amountWdr: {
                required: 'Vui lòng nhập tiền giao dịch',
            }
        },
        errorLabelContainer: "#modalWithdraw .error-area",
        errorPlacement: function (error, element) {
            error.appendTo("#modalWithdraw .error-area");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $('.error-area').removeClass('show').addClass('hide').empty();
                $("#modalWithdraw .error-area").removeClass("hide").addClass("show");
            } else {
                $("#modalWithdraw .error-area").removeClass("show").addClass("hide").empty();
                $("#formWdr input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.commands.withdraw();
        }
    })

    page.elements.formTransfer.validate({
        rules: {
            amountTr: {
                isNumber: true,
                required: true
            }
        },
        messages: {
            amountTr: {
                required: 'Vui lòng nhập số tiền'
            }
        },
        errorLabelContainer: "#modalTransfer .error-area",
        errorPlacement: function (error, element) {
            error.appendTo("#modalTransfer .error-area");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $('.error-area').removeClass('show').addClass('hide').empty();
                $("#modalTransfer .error-area").removeClass("hide").addClass("show");
            } else {
                $("#modalTransfer .error-area").removeClass("show").addClass("hide").empty();
                $("#formTr input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            page.commands.transfer();

        }
    })


    $.validator.addMethod("isEmail", function (value, element) {
        return this.optional(element) || /^[a-z]+@[a-z]+\.[a-z]+$/i.test(value);
    }, "Vui lòng nhập đúng định dạng email");
    $.validator.addMethod("isNumberWithSpace", function (value, element) {
        return this.optional(element) || /^[0][0-9]{9}$/i.test(value);
    }, "Vui lòng nhập 10 số bắt đầu là 0");
    $.validator.addMethod("isNumber", function (value, element) {
        return this.optional(element) || /^[0-9]*$/i.test(value);
    }, "Vui lòng nhập tiền giao dịch bằng ký tự số");

    const initializeControlEvent = () => {
        page.elements.btnShowModalCreate.on('click', () => {
            resetForm('#formCreate');
            page.elements.modalCreate.modal('show');
        })

        page.elements.btnCreate.on('click', () => {
            page.elements.frmCreate.trigger('submit');
        })

        page.elements.btnUpdate.on('click', () => {
            page.elements.frmUpdate.trigger('submit');
        })

        // page.elements.modalDeposit.on('hide.bs.modal', () => {
        //     $('.error-area').empty().addClass('hide');
        // })

        page.elements.btnDeposit.on('click', () => {
            page.elements.formDeposit.trigger('submit');
        })

        // modalWithdraw.on('hide.bs.modal', () => {
        //     $('.error-area').empty().addClass('hide');
        // })

        page.elements.btnWithdraw.on('click', () => {
            page.elements.formWithdraw.trigger('submit');
        })

        page.elements.btnTransfer.on('click', () => {
            page.elements.formTransfer.trigger('submit');
        })

    }

    const resetForm = (elem) => {
        $(elem).trigger('reset');
        $(`${elem} label.error`).remove();
        $(`${elem} input`).removeClass('error');
        $('.error-area').empty()
    }

    $(() => {
        page.commands.getAllCustomers();
        initializeControlEvent();
        page.commands.deleteCustomer();
        page.commands.showUpdate();

        page.commands.getAllProvinces().then((data) => {
            const provinceId = page.elements.provinceCre.val();

            page.commands.getAllDistrictsByProvinceId(provinceId, page.elements.districtCre).then((data) => {
                const districtId = page.elements.districtCre.val();

                page.commands.getAllWardsByDistrictId(districtId, page.elements.wardCre);
            })
        });
        page.commands.showDeposit();
        page.commands.showWithdraw();
        page.commands.showTransfer();
    })

</script>


</body>
</html>